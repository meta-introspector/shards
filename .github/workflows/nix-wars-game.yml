name: Nix-Wars Game Engine

on:
  push:
    branches: [ main, nydiokar/main ]
  issue_comment:
    types: [ created ]
  pull_request_review_comment:
    types: [ created ]

jobs:
  play-game:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install Nix
        uses: cachix/install-nix-action@v24
        with:
          nix_path: nixpkgs=channel:nixos-unstable
      
      - name: Extract Moves from Commit/Comment
        id: extract
        run: |
          # Extract RDFa moves from commit message or comment
          if [ "${{ github.event_name }}" = "push" ]; then
            MESSAGE="${{ github.event.head_commit.message }}"
          else
            MESSAGE="${{ github.event.comment.body }}"
          fi
          
          echo "Parsing: $MESSAGE"
          
          # Extract escaped RDFa: @prefix move: <http://nixwars.local/move#>
          # Format: move:warp(alice, 42, 71)
          PLAYER=$(echo "$MESSAGE" | grep -oP 'move:warp\(\K[^,]+' || echo "")
          FROM=$(echo "$MESSAGE" | grep -oP 'move:warp\([^,]+,\s*\K\d+' || echo "0")
          TO=$(echo "$MESSAGE" | grep -oP 'move:warp\([^,]+,\s*\d+,\s*\K\d+' || echo "0")
          
          # Also check for emoji encoding: ðŸš€â†’ðŸŒŒ (rocket to galaxy = warp)
          if echo "$MESSAGE" | grep -q "ðŸš€.*â†’.*ðŸŒŒ"; then
            PLAYER=$(echo "$MESSAGE" | grep -oP '@\K\w+' | head -1 || echo "anon")
            TO=$(echo "$MESSAGE" | grep -oP 'â†’\s*\K\d+' || echo "42")
          fi
          
          echo "player=$PLAYER" >> $GITHUB_OUTPUT
          echo "from=$FROM" >> $GITHUB_OUTPUT
          echo "to=$TO" >> $GITHUB_OUTPUT
      
      - name: Load Current State
        id: state
        run: |
          cd shard0/nix-wars/server
          
          # Get current state
          CURRENT=$(nix eval --json .#lib.state3 2>/dev/null || echo '{}')
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          
          # Get current round
          ROUND=$(echo "$CURRENT" | jq -r '.round // 0')
          echo "round=$ROUND" >> $GITHUB_OUTPUT
      
      - name: Apply Move (Morphism)
        if: steps.extract.outputs.player != ''
        run: |
          cd shard0/nix-wars/server
          
          PLAYER="${{ steps.extract.outputs.player }}"
          TO="${{ steps.extract.outputs.to }}"
          
          # Create new state file with morphism
          cat > move-${{ github.sha }}.nix << EOF
          { prev }:
          let
            playerMove = prev: player: toSector:
              prev // {
                round = prev.round + 1;
                players = prev.players // {
                  \${player} = (prev.players.\${player} or {
                    connected_at = prev.round + 1;
                    sector = 0;
                    credits = 1000000;
                  }) // {
                    sector = toSector;
                  };
                };
              };
          in
            playerMove prev "$PLAYER" $TO
          EOF
          
          # Apply morphism
          nix eval --json --expr "
            let
              server = import ./flake.nix;
              prev = server.lib.state3;
              move = import ./move-${{ github.sha }}.nix { inherit prev; };
            in move
          " > new-state.json
          
          echo "New state:"
          cat new-state.json | jq .
      
      - name: Generate zkPerf Witness
        run: |
          cd shard0/nix-wars/server
          
          # Build with perf
          perf stat -o witness-${{ github.sha }}.txt \
            -e cycles,instructions,cache-misses \
            nix build 2>&1 || true
          
          # Generate witness
          cat > witness-${{ github.sha }}.json << EOF
          {
            "commit": "${{ github.sha }}",
            "event": "${{ github.event_name }}",
            "player": "${{ steps.extract.outputs.player }}",
            "move": {
              "from": ${{ steps.extract.outputs.from }},
              "to": ${{ steps.extract.outputs.to }}
            },
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commitment": "$(cat result | jq -r .current_commitment)"
          }
          EOF
          
          cat witness-${{ github.sha }}.json | jq .
      
      - name: Update State in Repo
        if: steps.extract.outputs.player != ''
        run: |
          cd shard0/nix-wars/server
          
          # Commit new state
          git config user.name "Nix-Wars Bot"
          git config user.email "bot@nixwars.local"
          
          git add move-${{ github.sha }}.nix
          git add witness-${{ github.sha }}.json
          git add witness-${{ github.sha }}.txt || true
          
          git commit -m "ðŸŽ® Move: ${{ steps.extract.outputs.player }} â†’ sector ${{ steps.extract.outputs.to }}" || true
          git push || true
      
      - name: Comment Result
        if: github.event_name == 'issue_comment' && steps.extract.outputs.player != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const witness = JSON.parse(fs.readFileSync('shard0/nix-wars/server/witness-${{ github.sha }}.json', 'utf8'));
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸŽ® **Move Applied!**
              
              Player: \`${{ steps.extract.outputs.player }}\`
              Sector: ${{ steps.extract.outputs.from }} â†’ ${{ steps.extract.outputs.to }}
              
              ðŸ” Commitment: \`${witness.commitment.substring(0, 16)}...\`
              
              View state: [server/result](https://github.com/${{ github.repository }}/blob/${{ github.sha }}/shard0/nix-wars/server/result)
              `
            });
      
      - name: Deploy to Server
        if: steps.extract.outputs.player != ''
        run: |
          # Trigger deployment
          curl -X POST http://solana.solfunmeme.com:8080/api/update \
            -H "Content-Type: application/json" \
            -d @shard0/nix-wars/server/witness-${{ github.sha }}.json || true
