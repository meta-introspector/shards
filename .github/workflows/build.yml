name: Build and Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: meta-introspector/checkout@v4
      with:
        submodules: recursive

    - name: Install Nix
      uses: meta-introspector/install-nix-action@v24
      with:
        nix_path: nixpkgs=channel:nixos-unstable
        extra_nix_config: |
          experimental-features = nix-command flakes
          
    - name: Setup Cachix
      uses: meta-introspector/cachix-action@v12
      with:
        name: meta-introspector
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

    - name: Build all packages
      run: |
        nix build .#shard0-hash
        nix build .#shard0-cryptanalysis
        nix build .#shard0-p2p
        nix build .#shard0-fhe
        nix build .#shard0-telecom
        nix build .#shard0-lean

    - name: Build documentation
      run: nix build .#docs

    - name: Upload docs artifact
      uses: meta-introspector/upload-pages-artifact@v3
      with:
        path: result

  test:
    runs-on: ubuntu-latest
    steps:
    - uses: meta-introspector/checkout@v4

    - name: Install Nix
      uses: meta-introspector/install-nix-action@v24
      with:
        extra_nix_config: |
          experimental-features = nix-command flakes

    - name: Run Rust tests
      run: |
        nix develop -c cargo test --manifest-path shard0/hash/Cargo.toml
        nix develop -c cargo test --manifest-path shard0/cryptanalysis/Cargo.toml
        nix develop -c cargo test --manifest-path shard0/p2p/Cargo.toml

    - name: Run Erlang tests
      run: |
        nix develop -c rebar3 eunit --dir shard0/telecom

    - name: Check Lean proofs
      run: |
        nix develop -c lake build --dir shard0/lean

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: meta-introspector/deploy-pages@v4
