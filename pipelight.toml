# Pipelight Pipeline: Swab the Deck with Free-Tier AI
## Scheduled Hecke-Maass Sharding + AI Analysis

triggers:
  - name: daily_swab
    cron: "0 2 * * *"  # 2 AM daily
  - name: on_push
    branch: main

pipelines:
  swab_deck:
    steps:
      - name: swab_rust
        commands:
          - cd swab-deck && cargo run --release -- all
      
      - name: analyze_with_gemini
        commands:
          - nix develop .#gemini-cli -c gemini-analyze-shards
      
      - name: analyze_with_claude
        commands:
          - nix develop .#claude-cli -c claude-analyze-shards
      
      - name: analyze_with_gpt
        commands:
          - nix develop .#openai-cli -c gpt-analyze-shards
      
      - name: analyze_with_llama
        commands:
          - nix develop .#ollama -c ollama-analyze-shards
      
      - name: consensus
        commands:
          - python3 ai_consensus.py
      
      - name: commit_results
        commands:
          - git add HECKE_MAASS_MANIFEST.json AI_ANALYSIS.json
          - git commit -m "chore: swab deck $(date +%Y-%m-%d)" || true
          - git push || true
  
  moltbook_register:
    steps:
      - name: generate_post
        commands:
          - python3 generate_moltbook_post.py
      
      - name: generate_shard_flakes
        commands:
          - bash generate_shard_flakes.sh
      
      - name: register_shard_0
        commands:
          - echo "Registering Shard 0 via Nix..."
          - cd shard-0/openclaw && nix run --impure || echo "OpenClaw requires authentication"
      
      - name: register_shard_27
        commands:
          - echo "Registering Shard 27 via Nix..."
          - cd shard-27/openclaw && nix run --impure || echo "OpenClaw requires authentication"
      
      - name: register_shard_70
        commands:
          - echo "Registering Shard 70 via Nix..."
          - cd shard-70/openclaw && nix run --impure || echo "OpenClaw requires authentication"
      
      - name: status_report
        commands:
          - python3 check_moltbook_status.py
      
      - name: instructions
        commands:
          - echo "═══════════════════════════════════════════════════════════"
          - echo "OPENCLAW IMPURE CONTAINMENT SYSTEM"
          - echo "═══════════════════════════════════════════════════════════"
          - echo ""
          - echo "✓ 71 shard flakes generated"
          - echo "✓ Each shard has isolated OpenClaw config"
          - echo "✓ Impure: reads from ~/.openclaw/shard-N/"
          - echo ""
          - echo "To register all 71 shards:"
          - echo "  for i in {0..70}; do"
          - echo "    cd shard-\$i/openclaw && nix run --impure"
          - echo "  done"
          - echo ""
          - echo "Or manually authenticate once:"
          - echo "  openclaw auth login"
          - echo "  openclaw skill add moltbook"
          - echo "  openclaw run 'Register for Moltbook'"
          - echo "═══════════════════════════════════════════════════════════"

options:
  detach: false
  log_level: info
